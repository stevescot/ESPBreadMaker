<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firmware Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <script src="update.js"></script>
</head>
<body>
  <nav>
    <a href="/">&#8962; Home</a>
    <a href="/config.html">&#9881; Config</a>
    <a href="/programs.html">&#128221; Programs</a>
    <a href="/calibration.html">&#127777; Calibration</a>
    <a href="/controllertuning.html">&#128293; PID Tuning</a>
    <a href="/update.html" class="active">&#11014; Update</a>
  </nav>
  <div class="container">
    <h2>Firmware Update</h2>
    <div id="fwBuildInfo" style="margin-bottom:10px;color:#555;font-size:0.95em"></div>
    
    <div style="margin:15px 0; padding:12px; background:#d32f2f; color:white; border-radius:6px; border-left:4px solid #b71c1c;">
      <b>&#9888; CRITICAL: HIGH IRAM USAGE DETECTED</b><br>
      <div style="margin-top:8px;">Your firmware uses <b>94% IRAM (62,007/65,536 bytes)</b>. OTA updates fail when IRAM usage exceeds 90% because the ESP8266 needs additional memory during the update process.</div>
      <div style="margin-top:8px; font-size:0.9em;">
        <b>Solutions:</b> Remove ICACHE_RAM_ATTR from non-critical functions, use serial upload instead, or reduce code size.<br>
        <b>Quick fix:</b> Comment out WebSocket server (#include &lt;WebSocketsServer.h&gt;) to save 2-3KB IRAM.
      </div>
    </div>
    
    <div id="fwUploadMsg" style="margin:10px 0;color:#1976d2;font-weight:bold;"></div>
    <form method="POST" action="/update" enctype="multipart/form-data" id="updateForm">
      <input type="file" name="firmware" id="firmwareFile" accept=".bin">
      <button type="submit" id="uploadBtn">Upload & Flash</button>
    </form>
    <div style="margin:15px 0; padding:10px; background:#333; border-radius:4px; font-size:0.9em;">
      <b>Troubleshooting Update Failures:</b><br>
      <div style="margin:5px 0;"><b>IRAM Issues (Most Common):</b></div>
      • <span style="color:#ff6b6b;"><b>Remove ICACHE_RAM_ATTR</b></span> from non-interrupt functions<br>
      • <span style="color:#ff6b6b;"><b>Replace with ICACHE_FLASH_ATTR</b></span> to move code to flash<br>
      • <span style="color:#ff6b6b;"><b>Use serial upload</b></span> (USB cable) instead of OTA when IRAM >90%<br>
      <div style="margin:5px 0;"><b>File Issues:</b></div>
      • Ensure .bin file is compiled for ESP8266 (not ESP32)<br>
      • File size should be under 1MB<br>
      <div style="margin:5px 0;"><b>Connection Issues:</b></div>
      • Ensure stable power and good WiFi signal<br>
      • Close serial monitor and other connections<br>
      • Try restarting device before update<br>
    </div>
    <p>Upload a compiled .bin file from Arduino IDE. The device will reboot after successful update.<br>
    <b>Note:</b> If the connection is interrupted, wait 10–30 seconds and refresh this page.<br>
    </p>
    <button onclick="window.location.href='/'">Back</button>
  </div>
</body>
</html>
