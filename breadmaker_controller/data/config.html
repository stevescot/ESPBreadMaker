<!DOCTYPE html>
<html>
<head>
  <title>Configuration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .config-links {
      display: flex;
      flex-direction: column;
      gap: 1.2em;
      align-items: center;
      margin-top: 2em;
    }
    .config-link-btn {
      font-size: 1.2em;
      padding: 0.7em 2.2em;
      border-radius: 8px;
      border: none;
      background: #444;
      color: #fff;
      cursor: pointer;
      transition: background 0.18s;
    }
    .config-link-btn:hover {
      background: #666;
    }
    .back-btn {
      margin-top: 3em;
      background: #222;
      color: #bbb;
      padding: 0.5em 1.8em;
      border-radius: 6px;
      font-size: 1em;
      border: none;
      cursor: pointer;
    }
    #fileManager table {
      color: #fff;
      font-size: 0.9em;
    }
    #fileManager th {
      background: #444;
      color: #fff;
      font-weight: bold;
    }
    #fileManager td {
      color: #ccc;
    }
    #fileManager button:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Configuration</h2>
    <div class="config-links">
      <button class="config-link-btn" onclick="location.href='/programs.html'">Edit Programs</button>
      <button class="config-link-btn" onclick="location.href='/calibration.html'">Calibrate Temperature</button>
      <button class="config-link-btn" onclick="location.href='/controllertuning.html'">üéõÔ∏è PID Controller Tuning</button>
      <button class="config-link-btn" onclick="location.href='/update.html'">Firmware Update</button>
      <button class="config-link-btn" onclick="toggleFileManager()">File Manager</button>
    </div>
    
    <!-- File Manager Section -->
    <div id="fileManager" style="display:none; margin-top:2em; padding:1.5em; border:1px solid #555; border-radius:8px; background:#333;">
      <h3 style="margin-top:0;">File Manager</h3>
      
      <!-- File Upload -->
      <div style="margin-bottom:2em;">
        <h4>Upload File</h4>
        <div style="margin-bottom:0.5em; color:#bbb; font-size:0.9em; font-style:italic;">
          üí° Tip: Multiple files are uploaded sequentially to prevent corruption
        </div>
        <input type="file" id="fileInput" multiple style="margin:0.5em 0; padding:0.5em; border-radius:4px; background:#444; color:#fff; border:1px solid #666;">
        <button onclick="uploadFiles()" style="margin-left:1em; padding:0.5em 1em; border-radius:4px; background:#4CAF50; color:#fff; border:none; cursor:pointer;">Upload</button>
        <div id="uploadStatus" style="margin-top:0.5em; color:#ffd600;"></div>
      </div>
      
      <!-- File List -->
      <div>
        <h4>Files on Device</h4>
        <button onclick="refreshFileList()" style="margin-bottom:1em; padding:0.3em 1em; border-radius:4px; background:#666; color:#fff; border:none; cursor:pointer;">Refresh</button>
        <div id="fileList" style="max-height:300px; overflow-y:auto; background:#222; padding:1em; border-radius:4px; border:1px solid #555;">
          Loading...
        </div>
      </div>
    </div>
    <div style="margin:2em 0 1em 0; text-align:center;">
      <label style="font-size:1.1em;">
        Output Mode:
        <select id="outputModeSelect" style="margin-left:0.7em; font-size:1em; padding:0.3em 1em; border-radius:6px;">
          <option value="digital">Digital (ON/OFF)</option>
          <option value="analog">Analog (PWM)</option>
        </select>
      </label>
      <span id="outputModeStatus" style="margin-left:1em; color:#ff9933;"></span>
    </div>
    <div style="margin:1.5em 0 1em 0; text-align:center;">
      <label style="font-size:1.1em;">
        Debug Serial:
        <input type="checkbox" id="debugSerialCheckbox" style="transform:scale(1.3);margin-left:0.7em;vertical-align:middle;">
      </label>
      <span id="debugSerialStatus" style="margin-left:1em; color:#ffd600;"></span>
    </div>
    <button class="back-btn" onclick="location.href='/'">Back</button>
  </div>
  <script src="debug_serial.js"></script>
  <script>
    // Output mode switch logic
    const outputModeSelect = document.getElementById('outputModeSelect');
    const outputModeStatus = document.getElementById('outputModeStatus');
    function fetchOutputMode() {
      fetch('/api/output_mode')
        .then(r => r.json())
        .then(d => {
          outputModeSelect.value = d.mode;
          outputModeStatus.textContent = d.mode === 'digital' ? 'Digital (ON/OFF)' : 'Analog (PWM)';
        });
    }
    outputModeSelect.onchange = function() {
      fetch('/api/output_mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: outputModeSelect.value})
      })
      .then(r => r.json())
      .then(d => {
        outputModeStatus.textContent = d.mode === 'digital' ? 'Digital (ON/OFF)' : 'Analog (PWM)';
      });
    };
    fetchOutputMode();
    
    // File Manager functionality
    function toggleFileManager() {
      const fileManager = document.getElementById('fileManager');
      if (fileManager.style.display === 'none') {
        fileManager.style.display = 'block';
        refreshFileList();
      } else {
        fileManager.style.display = 'none';
      }
    }
    
    async function uploadFiles() {
      const fileInput = document.getElementById('fileInput');
      const uploadStatus = document.getElementById('uploadStatus');
      const files = fileInput.files;
      
      if (files.length === 0) {
        uploadStatus.textContent = 'Please select files to upload';
        uploadStatus.style.color = '#ff6666';
        return;
      }
      
      uploadStatus.textContent = 'Uploading files sequentially...';
      uploadStatus.style.color = '#ffd600';
      
      let successCount = 0;
      let errorCount = 0;
      
      // Upload files one by one to prevent memory issues and corruption
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append('file', file);
        
        uploadStatus.textContent = `Uploading ${i + 1}/${files.length}: ${file.name}...`;
        
        try {
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            successCount++;
            uploadStatus.textContent = `‚úÖ Uploaded ${i + 1}/${files.length}: ${file.name} (${successCount} success, ${errorCount} errors)`;
            uploadStatus.style.color = '#4CAF50';
            
            // Small delay between uploads to prevent overwhelming the ESP32
            if (i < files.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 500)); // 500ms delay
            }
          } else {
            errorCount++;
            uploadStatus.textContent = `‚ùå Error uploading ${file.name}: HTTP ${response.status}`;
            uploadStatus.style.color = '#ff6666';
            break; // Stop on first error
          }
        } catch (error) {
          errorCount++;
          uploadStatus.textContent = `‚ùå Error uploading ${file.name}: ${error.message}`;
          uploadStatus.style.color = '#ff6666';
          break; // Stop on first error
        }
      }
      
      // Final status
      if (errorCount === 0) {
        uploadStatus.textContent = `‚úÖ Successfully uploaded all ${successCount} file(s)`;
        uploadStatus.style.color = '#4CAF50';
        fileInput.value = '';
        refreshFileList();
      } else {
        uploadStatus.textContent = `‚ö†Ô∏è Upload completed with ${errorCount} error(s). ${successCount} file(s) uploaded successfully.`;
        uploadStatus.style.color = '#ffc107';
      }
    }
    
    function refreshFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = 'Loading...';
      
      fetch('/api/files')
        .then(response => response.json())
        .then(data => {
          if (data.files.length === 0) {
            fileList.innerHTML = '<em>No files found</em>';
            return;
          }
          
          let html = '<table style="width:100%; border-collapse:collapse;">';
          html += '<thead><tr><th style="text-align:left; padding:0.5em; border-bottom:1px solid #555;">Name</th><th style="text-align:right; padding:0.5em; border-bottom:1px solid #555;">Size</th><th style="text-align:center; padding:0.5em; border-bottom:1px solid #555;">Actions</th></tr></thead>';
          html += '<tbody>';
          
          data.files.forEach(file => {
            html += '<tr>';
            html += `<td style="padding:0.5em; border-bottom:1px solid #333;">${file.name}</td>`;
            html += `<td style="padding:0.5em; border-bottom:1px solid #333; text-align:right;">${formatBytes(file.size)}</td>`;
            html += `<td style="padding:0.5em; border-bottom:1px solid #333; text-align:center;">`;
            html += `<button onclick="downloadFile('${file.name}')" style="margin-right:0.5em; padding:0.2em 0.5em; border-radius:3px; background:#4CAF50; color:#fff; border:none; cursor:pointer; font-size:0.8em;">Download</button>`;
            html += `<button onclick="deleteFile('${file.name}')" style="padding:0.2em 0.5em; border-radius:3px; background:#f44336; color:#fff; border:none; cursor:pointer; font-size:0.8em;">Delete</button>`;
            html += '</td>';
            html += '</tr>';
          });
          
          html += '</tbody></table>';
          fileList.innerHTML = html;
        })
        .catch(error => {
          fileList.innerHTML = `<em>Error loading files: ${error.message}</em>`;
        });
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function downloadFile(filename) {
      window.open('/' + filename, '_blank');
    }
    
    function deleteFile(filename) {
      if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
        return;
      }
      
      fetch('/api/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({filename: filename})
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'deleted') {
          refreshFileList();
        } else {
          alert(`Error deleting file: ${data.error}`);
        }
      })
      .catch(error => {
        alert(`Error deleting file: ${error.message}`);
      });
    }
  </script>
</body>
</html>
